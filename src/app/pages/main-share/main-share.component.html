<div class="app" [class.sidebar-collapsed]="sidebarCollapsed" [class.drawer-open]="sidebarOpen">

  <aside class="sidebar" [attr.aria-expanded]="!sidebarCollapsed">
    <div class="sidebar-inner">
      <header class="sb-header">
        <div class="brand">
          <span class="brand-icon">‚ö°</span>
          <span class="brand-text">Quick share</span>
        </div>

        <div class="sb-actions">
          <!-- New chat -->
          <button class="toolbar-btn only-expanded" [disabled]="!canNewChat" [attr.aria-disabled]="!canNewChat"
            [title]="canNewChat ? 'New chat' : 'Type a message first'" aria-label="New chat" (click)="newChat()">
            <!-- PLUS SVG -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>

          <button class="collapse-btn" (click)="toggleSidebar()" [attr.aria-label]="isMobile ? (sidebarOpen ? 'Close sidebar' : 'Open sidebar')
                                        : (sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar')">
            <svg class="chev" viewBox="0 0 24 24" aria-hidden="true"
              [class.point-right]="!isMobile && sidebarCollapsed">
              <!-- base l√† chevron-left -->
              <path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>
        </div>

      </header>

      <nav class="sb-nav">
        <button class="nav-item new-chat only-collapsed" (click)="newChat()" title="New chat" aria-label="New chat">
          <span class="icon">Ôºã</span>
          <span class="text">New chat</span>
        </button>

        <button class="nav-item"><span class="icon">üí¨</span><span class="text">All chats</span></button>
        <button class="nav-item"><span class="icon">‚≠ê</span><span class="text">Pinned</span></button>
        <button class="nav-item"><span class="icon">üóÇÔ∏è</span><span class="text">Folders</span></button>
      </nav>

      <!-- NEW: History -->
      <!-- ... ph·∫ßn tr√™n gi·ªØ nguy√™n ... -->

      <!-- History -->
      <section class="sb-history" *ngIf="sessions.length">
        <div class="section-label">Chats</div>

        <ul class="history-list">
          <li class="history-row" *ngFor="let s of sessions; trackBy: trackBySessionId">
            <!-- NORMAL MODE -->
            <ng-container *ngIf="editingId !== s.id; else editTpl">
              <button class="h-item" [class.active]="s.id === currentSessionId" (click)="openSession(s.id)">
                <span class="dot">üí¨</span>
                <span class="text">{{ s.title }}</span>
                <time class="time">{{ s.updatedAt | date:'HH:mm' }}</time>
              </button>

              <!-- actions l√† sibling ƒë·ªÉ ƒë·ª©ng ngang -->
              <div class="row-actions only-expanded">
                <button class="icon-btn sm" title="Rename" (click)="startEdit(s, $event)">
                  <svg viewBox="0 0 24 24">
                    <path
                      d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
                      fill="currentColor" />
                  </svg>
                </button>
                <button class="icon-btn sm danger" title="Delete" (click)="deleteSession(s.id, $event)">
                  <svg viewBox="0 0 24 24">
                    <path d="M3 6h18M8 6V4h8v2M6 6l1 14h10l1-14" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </button>
              </div>
            </ng-container>

            <!-- EDIT MODE -->
            <ng-template #editTpl>
              <div class="h-item edit-mode" (click)="$event.stopPropagation()">
                <span class="dot">‚úèÔ∏è</span>
                <input [id]="'edit-' + s.id" class="rename-input" type="text" [(ngModel)]="editingTitle"
                  spellcheck="false" (keydown)="onEditKeydown($event)" (blur)="commitEdit()"
                  aria-label="Rename chat title" />

                <span class="time"></span>
              </div>

              <!-- actions l√† sibling ƒë·ªÉ ƒë·ª©ng ngang -->
              <div class="row-actions only-expanded">
                <button class="icon-btn sm" title="Save" (mousedown)="$event.preventDefault()" (click)="commitEdit()">
                  <svg viewBox="0 0 24 24">
                    <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </button>
                <button class="icon-btn sm" title="Cancel" (mousedown)="$event.preventDefault()"
                  (click)="cancelEdit($event)">
                  <svg viewBox="0 0 24 24">
                    <path d="M18 6L6 18M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </button>
              </div>
            </ng-template>
          </li>

        </ul>
      </section>

    </div>
  </aside>
  <div class="backdrop only-mobile" (click)="closeDrawerByBackdrop()" aria-hidden="true"></div>

  <main class="main">
    <div class="topbar">
      <button class="hamburger only-mobile" (click)="toggleSidebarMobile()" aria-label="Open sidebar">‚ò∞</button>
      <div class="spacer"></div>
    </div>

    <div class="chat-layout" (mousedown)="trapFocus($event)">

      <ng-container *ngIf="messages.length === 0; else chatTpl">
        <section class="home-hero">
          <div class="hero-center">
            <h1 #homeHero class="home-title" aria-live="polite" [attr.aria-label]="heroTitle">
              <span class="type-text">{{ heroRendered }}</span>
              <span class="caret" *ngIf="showCaret"></span>
            </h1>
          </div>
          <div class="home-prompt">
            <label tabindex="-1" for="fileInput" class="icon-btn attach" aria-label="Attach files">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 12v8h16v-8M12 16V4m0 0l-4 4m4-4l4 4" fill="none" stroke="currentColor" stroke-width="1.8"
                  stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <span class="badge" *ngIf="fileCount > 0">{{ fileCount }}</span>
            </label>
            <input id="fileInput" type="file" multiple hidden (change)="onFilesChanged($event)" />
            <input #promptInputEl id="promptInput" type="text" placeholder="Type your answer here..."
              (keydown.enter)="send()" />
            <button id="sendBtn" type="button" class="icon-btn send" title="Send" aria-label="Send" (click)="send()">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M21 3L9 15M21 3l-7 19-5-7-7-5 19-7z" fill="none" stroke="currentColor" stroke-width="1.6"
                  stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
          </div>
        </section>
      </ng-container>

      <ng-template #chatTpl>
        <div class="chat-thread">
          <app-chat-thread class="chat-thread" [messages]="messages"></app-chat-thread>
        </div>

        <div class="prompt-box">
          <div class="prompt">
            <label tabindex="-1" for="fileInput" class="icon-btn attach" aria-label="Attach files">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 12v8h16v-8M12 16V4m0 0l-4 4m4-4l4 4" fill="none" stroke="currentColor" stroke-width="1.8"
                  stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <span class="badge" *ngIf="fileCount > 0">{{ fileCount }}</span>
            </label>
            <input id="fileInput" type="file" multiple hidden (change)="onFilesChanged($event)" />
            <input #promptInputEl id="promptInput" type="text" placeholder="Type your answer here..."
              (keydown.enter)="send()" />
            <button id="sendBtn" type="button" class="icon-btn send" title="Send" aria-label="Send" (click)="send()">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M21 3L9 15M21 3l-7 19-5-7-7-5 19-7z" fill="none" stroke="currentColor" stroke-width="1.6"
                  stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
          </div>
        </div>
      </ng-template>

    </div>
  </main>
</div>